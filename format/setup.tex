%%%% contact via <kisfg@hotmail.com, haikureimu@hnu.edu.cn>
\setlength{\headheight}{13pt} % 页眉可以放得大一点
%%% 控制行距
\setlength{\parindent}{2em}
%%% 定义字体
% pdflatex 下不可用。
% \xeCJKsetcharclass{"25A0}{"25A2}{1} % 方框
\newcommand{\song}{\songti}     % 宋体 rm
\newcommand{\hei}{\heiti}       % 黑体 bf 
\newcommand{\fs}{\fangsong}     % 仿宋体 tt
\newcommand{\kai}{\kaishu}      % 楷体 it
\newcommand{\li}{\lishu}        % 隶书


%%% 修改百分号的字体样式
% 仙之人兮列如麻 
%   https://tex.stackexchange.com/a/272044
%   https://tex.stackexchange.com/a/272043
% \let\svpct\%
% \def\overlayclr{white}
% \renewcommand{\%}{\scalerel*{\stackon[0pt]{\stackon[0pt]{\normalsize\svpct}{\smash{%
%   \textcolor{\overlayclr}{\rotatebox{56.8}{\rule[-4.55pt]{2.5pt}{1.5pt}}}}}}%
%   {\smash{\textcolor{\overlayclr}{%
%   \rotatebox{27}{\kern-.84pt\rule[-2.5pt]{1.5pt}{2.5pt}}}}}}{\svpct}}
\let\origpercent\%
\renewcommand{\%}{{\fontfamily{jkp}\selectfont{\origpercent}}}
\newcommand{\perthousand}{{\fontfamily{jkp}\selectfont{‰}}} % 定义为千分号
% TODO \newcommand{\pertenthousand}{{\fontfamily{jkp}\selectfont{‱}}}
% 不过，什么领域的数据会用万分号呢 ？\rotatebox{-15}{/} 


%%%% 字号换算规范
%%%% 中文常用字号来代替国际用点数/磅/英寸/pt。
%% 参考 https://www.runoob.com/w3cnote/px-pt-em-convert-table.html
\newcommand{\chuhao}{\fontsize{42pt}{42pt}\selectfont}      % 初号, 1.倍行距
\newcommand{\yihao}{\fontsize{26pt}{26pt}\selectfont}       % 一号, 1.倍行距
\newcommand{\xiaoyi}{\fontsize{24pt}{24pt}\selectfont}      % 小一, 1.倍行距
\newcommand{\erhao}{\fontsize{22pt}{22pt}\selectfont}       % 二号, 1.倍行距
\newcommand{\xiaoer}{\fontsize{18pt}{18pt}\selectfont}      % 小二, 单倍行距
\newcommand{\sanhao}{\fontsize{16pt}{16pt}\selectfont}      % 三号, 1.倍行距
\newcommand{\xiaosan}{\fontsize{15pt}{15pt}\selectfont}     % 小三, 1.倍行距
\newcommand{\sihao}{\fontsize{14pt}{14pt}\selectfont}       % 四号, 1.倍行距
\newcommand{\xiaosi}{\fontsize{12pt}{14.4pt}\selectfont}      % 小四, 1.倍行距
\newcommand{\wuhao}{\fontsize{10pt}{10pt}\selectfont}       % 五号, 单倍行距
\newcommand{\xiaowu}{\fontsize{9pt}{9pt}\selectfont}        % 小五, 单倍行距
\CJKtilde

% TODO: 枚举列表项的设置
\setitemize{leftmargin=3.5em,itemsep=0em,partopsep=0em,parsep=0em,topsep=0em}
\setenumerate{leftmargin=3.5em,itemsep=0em,partopsep=0em,parsep=0em,topsep=0em}
\setstretch{1.625}
% \renewcommand{\baselinestretch}{1.5} % \Normalsize\selectfont

\makeatletter
    \newcommand\Normalsize{%  % 1.5 * 1.3 / 1.2
        \@setfontsize\Normalsize{12pt}{12pt}
        \setlength\abovedisplayskip{4pt}
        \setlength\abovedisplayshortskip{4pt}
        \setlength\belowdisplayskip{4pt}
        \setlength\belowdisplayshortskip{4pt}
        \let\@listi\@listI
    }
    % TMD 我是真一点也不想用这个
    \def\Defaultfont{\renewcommand{\baselinestretch}{2}\Normalsize\selectfont}
\makeatother

%% 这个块不要动，否则会引起 hyperref 的跳转错误。
\def\functor{\relax}
\let\functor\addcontentsline
\gdef\addcontentsline{\phantomsection\functor} % 这样就能修改addcontentsline的功能，使其额外插入。


%%% 配置目录
\renewcommand*{\contentsname}{\hspace{11em}目\hspace{4em}录\hspace{12em}}
\setcounter{secnumdepth}{3}     % 编号深度 3
\setcounter{tocdepth}{2}        % 目录项深度为 2，篇幅多了老师给的建议是只到 1.2 这样的子章节。
\renewcommand{\thefigure}{\arabic{figure}}
\renewcommand{\thetable}{\arabic{table}}
\renewcommand{\theequation}{\arabic{equation}} % bold equation numbers
%% 目录项中的基本配件。
\renewcommand{\cftdot}{$...$}   % 点的样式。
\renewcommand{\cftdotsep}{1.5}
% 调整索引与文献名称之间的水平间距
\renewcommand{\biblabelsep}{6pt}
% section 从 1 开始计数
\renewcommand{\thesection}{\arabic{section}}

% TODO: section 格式配置需要调。
\titlecontents{section}[0em]    % 标题级别 标题位置 (左间距，理解为缩进)
    {\xiaosi\hei\vspace{0.5em}} % 标题样式
    {\textbf{\thecontentslabel}\hspace{0.5em}} 
    {} % 标题格式 (设置标题的整体格式，如字体尺寸、粗细、与上一个标题的垂直距离等，可空置)
    {\titlerule*[10pt]{\cftdot}\xiaosi\contentspage} 
    % 指引线与页码 (设置标题与页码之间的指引线样式以及页码的格式，该参数如果空置，标题将无指引线和页码)
% subsection 格式配置
\titlecontents{subsection}[2em]
    {\xiaosi\song\vspace{0.5em}}
    {\thecontentslabel\hspace{0.5em}}
    {}
    {\titlerule*[10pt]{\cftdot}\xiaosi\contentspage}
% subsubsection 格式配置
\titlecontents{subsubsection}[4em]
    {\xiaosi\song\vspace{0.5em}}
    {\thecontentslabel\hspace{0.5em}}
    {}
    {\titlerule*[10pt]{\cftdot}\xiaosi\contentspage}

%%% 图表目录以及格式定义。
\renewcommand*{\listfigurename}{\hfill 插图索引 \hfill}
\renewcommand*{\listtablename}{\hfill 附表索引 \hfill}
\setcounter{lofdepth}{1}
% figure index 的格式配置
\titlecontents{figure}[0em]
    {\xiaosi\song\vspace{0.5em}} %
    {图\hspace{0.5em}\textnormal{\thecontentslabel}\hspace{0.5em}}{} %
    {\titlerule*[10pt]{\cftdot}\xiaosi\contentspage}
% table index 的格式配置
\titlecontents{table}[0em]
    {\xiaosi\song\vspace{0.5em}} %
    {表\hspace{0.5em}\textnormal{\thecontentslabel}\hspace{0.5em}}{} %
    {\titlerule*[10pt]{\cftdot}\xiaosi\contentspage}
\numberwithin{equation}{section} % 公式按章节编号
\numberwithin{figure}{section} % 图按章节编号
\numberwithin{table}{section} % 表也按照章节编号


%% 设置插图目录条目的字体格式
% 直接重定义字体即可。
% https://tex.stackexchange.com/a/372825
% https://tex.stackexchange.com/a/192450
\DeclareCaptionFont{chineseBoldSongti}{\bfseries\songti\wuhao}
\DeclareCaptionFont{chineseWuHaoSongti}{\songti\wuhao}
\DeclareCaptionFont{chineseBoldHeiti}{\bfseries\heiti\wuhao}
\DeclareCaptionFont{chineseWuhao}{\wuhao}
\DeclareCaptionLabelFormat{figLabel}{#1~#2\hspace{0.5em}}
\DeclareCaptionLabelFormat{tabLabel}{#1~#2~}
% TOFIX: captionsetup 只能在导言区用也是神了
\captionsetup[figure]{
    name={\textbf{\song\wuhao{图}}},
    labelsep=space, % 去掉冒号
    labelformat=figLabel,
    font={chineseWuhao},          
    labelfont={bf},         
    textfont={chineseBoldSongti},   
    skip=0.5em,
}
\captionsetup[subfigure]{
    font={chineseWuhao},
    labelfont={chineseWuHaoSongti},
    textfont={chineseWuHaoSongti}
}
\captionsetup[table]{
    name={\textbf{\hei\wuhao{表}}},
    labelsep=space, % 去掉冒号
    labelformat=tabLabel,
    font={chineseWuhao},
    labelfont={bf},         
    textfont={chineseBoldHeiti}, 
    skip=0.5em,       
}
% \renewcommand{\numberline}[1]{图~#1~~}
% \renewcommand{\numberline}[1]{表~#1~~}
%% https://ctan.math.illinois.edu/macros/latex/contrib/biblatex-contrib/biblatex-gb7714-2015/biblatex-gb7714-2015.pdf
% 通过本地化字符串设置文中引用包括作者在内的文献的等、和
\DefineBibliographyStrings{english}{
    andincite = {\protect\unspace},
    andincitecn = {\protect\unspace},
    andothersincite = {et al\adddot}, % adddot才能避开标点追踪
    andothersincitecn = {等人},
}
% 通过标点设置等前的标点，比如：
% \DeclareDelimFormat[textcite]{andothersdelim}{} % \space
\DeclareDelimFormat[textcite,authornumcite,citet]{multinamedelim}
{\iffieldequalstr{userf}{chinese}{，}{\addcomma}} 
\DeclareDelimFormat[textcite,authornumcite,citet]{finalnamedelim}
{\iffieldequalstr{userf}{chinese}{，}{\addcomma}} 
\DeclareDelimFormat[textcite,authornumcite,citet]{andothersdelim}
{\iffieldequalstr{userf}{chinese}{，}{\addcomma}}
% \renewrobustcmd{\mkbibleftborder}{\hspace{-0.1em}[}%
% \renewrobustcmd{\mkbibrightborder}{]}%

%最后一个姓名与等之间的符号(间隔符)
% \DeclareDelimFormat[cite,parencite,pagescite]{andothersdelim}{，}%
% \DeclareDelimFormat[textcite]{andothersdelim}{，}%
% 除此之外，有时还需要设置finalnamedelim等来调整姓名间的标点。
% multinamedelim是各姓名之间的标点
% finalnamedelim是最后一个姓名前的取代multinamedelim的标点
% \setlength{\footskip}{40pt}
% windows画图中，120 pt = 460 minix-pixel
%                  x   =  120

%% 关闭连字
\DisableLigatures{encoding = *, family = *}
%%% 正文前页码配大写罗马字体编号
\newcounter{customCounter}
\newcommand{\mainmatter} {
    % \clearpage
    \clearpage
    % \topmargin -11mm
    % \headsep 12mm
    % \footskip 6.5mm
    \cfoot{\song\wuhao{\thepage}}
    \pagenumbering{arabic}
}
\makeglossaries
% \renewcommand{\glossaryTX}{arabic}
%%% 配置主目录中显示的节。
% 节
\titleformat{\section}{\sanhao\hei}{\thesection}{16pt}{}
\titlespacing{\section}{0pt}{6pt}{6pt}
% 子节
\titleformat{\subsection}{\xiaosi\hei}{\thesubsection}{12pt}{}
\titlespacing{\subsection}{0pt}{6pt}{6pt}
% 孙子节
\titleformat{\subsubsection}{\xiaosi\hei}{\thesubsubsection}{12pt}{}
\titlespacing{\subsubsection}{0pt}{6pt}{6pt}

\newcounter{paraCounter}
\setcounter{paraCounter}{1}

% 层次用到哪一层次视需要而定
% TODO: 节后无需“条”时可直接列“款”、“项”。“节”、“条”的段前、段后各设为0.5行
\titleformat{\paragraph}{\xiaosi\hei}{\theparagraph}{12pt}{} % {\arabic{paraCounter}. }[]
\titlespacing{\paragraph}{0pt}{7pt}{5pt}


% 问了老师，加粗就行。
% 后面又改成标号(1)(2)...的形式，需要注意这个必须要和下文以及上文隔开一行。
% 不然会引起格式错误。
% 实例：```
% 正文...
% 
% \subsubsubsection{(1) 我的世界}
% 
% 正文...
% ''' 
\newcommand{\subsubsubsection}[1]{
    {\vspace{3pt}\hspace{-2em}\xiaosi\hei{#1}\vspace{3pt}}
}

\renewcommand{\headrulewidth}{0pt}

%%%　配置注脚
%% tex.stackexchange.com/questions/639370/how-to-enumerate-footnotes-with-circled-numbers/639377#639377
% \node{#2}; \draw circle[radius=#1];
% \newcommand\circled[1]{\scalerel*{\tikz{\useasboundingbox (0.001,-0.3) rectangle (0,0);\node {\wuhao{#1}};}}{X}}
% \deffootnotemark{\textsuperscript{\hbox{\circled{\thefootnotemark}}}}
% \addtolength{\footnotesep}{-1em} %竖直方向的间距
% \addtolength{\skip\footins}{1.5em}

\newcommand{\tableCellAdjust}[2]{\begin{tabular}{c}#1 \\ #2\end{tabular}}
% https://tex.stackexchange.com/a/266686

%%% 制作前几页
%%% 定义特有字段以及特殊的变量和命令
\makeatletter
    %%% 封面配置
    % 校徽上的本科毕业论文（设计）
    \def\LieOnBadge#1{\def\@LieOnBadge{#1}}\def\@LieOnBadge{}
    % 封面页标题栏的第一行
    \def\titleOnTheFirstLine#1{\def\@titleOnTheFirstLine{\xiaoer\heiti{#1}}}\def\@titleOnTheFirstLine{}
    % 封面页标题栏的第二行
    \def\titleOnTheSecondLine#1{\def\@titleOnTheSecondLine{\xiaoer\heiti{#1}}}\def\@titleOnTheSecondLine{}
    % 中文标题，用于摘要页
    \def\title#1{\def\@title{#1}}\def\@title{}
    % 英文标题，用于英文摘要页
    \def\etitle#1{\def\@etitle{#1}}\def\@etitle{}
    % 文章作者
    \def\author#1{\def\@author{\centerline{\xiaosi\song{#1}}}}\def\@author{} 
    % 学号
    \def\studentid#1{\def\@studentid{\centerline{\xiaosi\song{#1}}}}\def\@studentid{}
    % 专业
    \def\major#1{\def\@major{\centerline{\xiaosi\song{#1}}}}\def\@major{}
    % 院系
    \def\faculty#1{\def\@faculty{\centerline{\xiaosi\song{#1}}}}\def\@faculty{}
    % 指导老师
    \def\teacher#1{\def\@teacher{\centerline{\xiaosi\song{#1}}}}\def\@teacher{}
    %%% 页眉配置
    % 页眉说明
    \def\heading#1{\def\@heading{#1}}\def\@heading{}
    %%% 摘要配置
    % 中文摘要
    \long\def\cabstract#1{\long\def\@cabstract{#1}}\long\def\@cabstract{}
    % 英文摘要
    \long\def\eabstract#1{\long\def\@eabstract{#1}}\long\def\@eabstract{}
    %%% 关键词配置
    % 中文关键词
    \def\ckeywords#1{\def\@ckeywords{#1}}\def\@ckeywords{}
    % 英文关键词
    \def\ekeywords#1{\def\@ekeywords{#1}}\def\@ekeywords{}
    
    % 必须存在此句。
    \newlength{\@title@width}

    \newcommand{\makethesisheaders} {
        \setlength{\tabcolsep}{0em} % 做之前紧凑
        %% 封面
        \begin{titlepage}
            \setcounter{page}{0}    % 必不可缺。解决了 page.I 和 page.1 重复的错误
            \centering
            % 湖南大学 毛主席题字
            \begin{figure*}[htp]
                \centering
                \includegraphics[width=0.5\textwidth]{figures/hnu}
            \end{figure*}
            % 高清校徽
            \vspace{-1em}
            \begin{overpic}[abs, unit=1mm, scale=.3,]{figures/HSVGPDF-transparent}
                % xelatex 和 pdflatex 在下面的数值上有差异。
                \put(0,63){\yihao\textbf{\texttt{HUNAN UNIVERSITY}}}
                \put(-33,35){\song\chuhao{\@LieOnBadge}}
            \end{overpic}\par
            \begin{table}[H]
                \centering
                \begin{tabular}{lrc}
                    % multicolumn 必须是第一条指令，前面只能是字体而不掺杂任何的命令。
                    \multicolumn{2}{r}{\xiaoer\hei\textbf{论文(设计)题目:\phantom{m}}}\rule{0pt}{1.07cm} & \underline{\parbox[c]{6cm}{\@titleOnTheFirstLine}} \\
                    &\multicolumn{1}{r}{}\rule{0pt}{1.07cm}      & \underline{\parbox[c]{6cm}{\@titleOnTheSecondLine}} \\
                    \rule{0pt}{1.07cm}&\xiaosi\hei{学\phantom{m}生\phantom{m}姓\phantom{m}名\phantom{m}:\phantom{m}} & \underline{\parbox[c]{6cm}{\@author}} \\
                    \rule{0pt}{1.07cm}&\xiaosi\hei{学\phantom{m}生\phantom{m}学\phantom{m}号\phantom{m}:\phantom{m}} & \underline{\parbox[c]{6cm}{\@studentid}} \\
                    \rule{0pt}{1.07cm}&\xiaosi\hei{专\phantom{m}业\phantom{m}班\phantom{m}级\phantom{m}:\phantom{m}} & \underline{\parbox[c]{6cm}{\@major}} \\
                    \rule{0pt}{1.07cm}&\xiaosi\hei{学\phantom{m}院\phantom{m}名\phantom{m}称\phantom{m}:\phantom{m}} & \underline{\parbox[c]{6cm}{\@faculty}} \\
                    \rule{0pt}{1.07cm}&\xiaosi\hei{指\phantom{m}导\phantom{m}老\phantom{m}师\phantom{m}:\phantom{m}} & \underline{\parbox[c]{6cm}{\@teacher}} \\
                \end{tabular}
            \end{table}\par
            \vspace{2em}
            \centering{\sihao\hei{\the\year{} 年 \the\month{} 月 20 日}}
            \pagestyle{empty}
        \end{titlepage}
        \clearpage
        %% 从此往后页眉的格式固定。
        \def\headrule{ 
            \if @fancyplain
                \let\headrulewidth\plainheadrulewidth
            \fi
            \hrule\@height 1.5pt \@width\headwidth          % 上面线为1pt粗
            \vskip 0.6pt
            \hrule\@height 1pt \@width\headwidth          
            \vskip-2\headrulewidth\vskip-1pt                % 两条线的距离1pt
            \vspace{8mm}                                    % 双线与下面正文之间的垂直间距
        }
        \pagestyle{fancy}
        \fancyhf{} % 清空所有fancy样式，方便使页眉左部和右部置空
        % \topmargin -11mm
        % \headsep 12mm
        % \footskip 6.5mm
        \chead{\song\xiaowu{\quad\@heading}}
        \cfoot{\song\wuhao{\thepage}}
        \pagenumbering{Roman}
        %%% 插入目录之中
        %% 授权书
        \addcontentsline{toc}{section}{毕业论文（设计）原创性声明和毕业论文（设计）版权使用授权书} { 
            \hei\xiaoer{
                \vspace{0.5em}\hspace*{8em}湖\hspace{0.5em}南\hspace*{0.5em}大\hspace{0.5em}学\vspace*{.6em}
                \par\vspace*{20.45pt}\hspace*{4em}毕业论文（设计）原创性声明\par\vspace{20.45pt}
            }
            \song\Defaultfont{
                本人郑重声明：所呈交的论文（设计）是本人在导师的指导下独立进行研究所取得的研究成果。
                除了文中特别加以标注引用的内容外，本论文（设计）不包含任何其他个人或集体已经发表或撰写的成果作品。
                对本文的研究做出重要贡献的个人和集体，均已在文中以明确方式标明。
                本人完全意识到本声明的法律后果由本人承担。
                \par\vspace{20.45pt}
                学生签名：\hspace{10.5em}日期： \the\year{} 年 \hspace{.5em} 月 \hspace{.5em} 日
                \par\vspace{40.9pt}
            }
            \begin{center}\hei\xiaoer{毕业论文（设计）版权使用授权书}\end{center}
            \par\vspace{12pt}
            \song\Defaultfont{
                本毕业论文（设计）作者完全了解学校有关保留、使用论文（设计）的规定，
                同意学校保留并向国家有关部门或机构送交论文（设计）的复印件和电子版，
                允许论文（设计）被查阅和借阅。本人授权湖南大学可以将本论文（设计）的全部或部分内容编入有关数据库进行检索，
                可以采用影印、缩印或扫描等复制手段保存和汇编本论文（设计）。
                \par
                本论文（设计）属于
                \par
                \vspace{-0.25em}\hspace{7.5em}1、保　密□，在\underline{\hspace{4em}}年解密后适用于本授权书。\par
                \vspace{-0.25em}\hspace{7.5em}2、不保密□。\par
                \vspace{-0.25em}\hspace{7.5em}(请在以上相应方框内打``$\surd$'')\par
                \vspace{1em}
                学生签名：\hspace{10.5em}日期： \the\year{} 年 \hspace{.5em} 月 \hspace{.5em} 日
                \par\vspace{0.5em}
                导师签名：\hspace{10.5em}日期： \the\year{} 年 \hspace{.5em} 月 \hspace{.5em} 日
            }
            % https://tex.stackexchange.com/a/675454
            % \symbol{"25A1} 为 xelatex 下可用！
            % 但 pdflatex 不可用
            % $\Box$ 很难看
        }
        \clearpage

        %% 中文摘要  
        \addcontentsline{toc}{section}{摘~~要} {
            \begin{center}
                \hei\xiaoer{\@title}
            \end{center}
            \vspace{-10pt}\vspace{12pt}
            \begin{center}
                \hei\xiaoer\ 摘\qquad 要
            \end{center}\vspace{12pt}

            \song\Defaultfont{\@cabstract}
            \vspace{20pt}
            \hangafter=1\hangindent=52.3pt
            \newline\noindent
            {\hei\sihao{关键词：} \hei\xiaosi\@ckeywords}
        }
        \clearpage
        
        %% 英文摘要
        \addcontentsline{toc}{section}{Abstract} {
            \begin{center}
                \xiaoer{\textbf{\@etitle}}
            \end{center}
            \par\vspace{12pt}
            \begin{center}
                \xiaoer\textbf{Abstract}
            \end{center}
            \par\vspace{12pt}
            \song\Defaultfont{\@eabstract}
            \vspace{20pt}
            \hangafter=1\hangindent=60pt
            \newline\noindent
            {\xiaosi\textbf{Key Words:} \@ekeywords}
        }
        \clearpage
        %%% 目录
        \tableofcontents
        \clearpage        
        %% 图表以及目录
        \setlength{\tabcolsep}{0.5em} % 做完上述部分后，表格默认每个格子 0.5em 宽

    }
    
    \def\headrule{ 
        \if @fancyplain
            \let\headrulewidth\plainheadrulewidth
        \fi
        \hrule\@height 1.0pt \@width\headwidth\vskip1pt % 上面线为1pt粗
        \hrule\@height 0.5pt \@width\headwidth          % 下面0.5pt粗
        \vskip-2\headrulewidth\vskip-1pt                % 两条线的距离1pt
        \vspace{7mm}                                    % 双线与下面正文之间的垂直间距
    }
    \pagestyle{fancy}
    \fancyhf{} % 清空所有fancy样式，方便使页眉左部和右部置空
    \chead{\song\xiaowu{\quad\@heading}}
\makeatother

%%% 附录命令配置
\newcommand{\setAppendixHere}[1] {
    \addcontentsline{toc}{section}{\song\xiaosi{附录 #1}} % 不得不为，如果有就必须要用 \songti 覆盖掉原有的配置 
    \setcounter{table}{0}   %从0开始编号，显示出来表会A1开始编号
    \setcounter{figure}{0}
    \setcounter{equation}{0}
    \section*{附录 #1}
    \renewcommand{\thetable}{#1.\arabic{table}}
    \renewcommand{\thefigure}{#1.\arabic{figure}}
    \renewcommand{\theequation}{#1.\arabic{equation}}
}

